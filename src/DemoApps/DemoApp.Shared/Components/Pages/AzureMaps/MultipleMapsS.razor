@using Marqdouj.DotNet.AzureMaps
@using Marqdouj.DotNet.AzureMaps.Map.Controls
@using Marqdouj.DotNet.AzureMaps.Map.Events
@using Marqdouj.DotNet.AzureMaps.Map.Interop
@using Marqdouj.DotNet.AzureMaps.Map.Configuration
@using Marqdouj.DotNet.Web.Components.FluentUI.Extensions
@using Microsoft.Extensions.Logging
@inject ILogger<MultipleMapsS> Logger
@inject IToastService ToastService

<PageTitle>Multiple Maps</PageTitle>

<FluentLayout>
    <MapPageHeader Header="@subject" LayerDef="@null" HRefSource="@hRefSource">
        <FluentStack Orientation="Orientation.Vertical">
            <FluentLabel>
                This example demonstrates adding more than one Azure Map component to a page.
                <br />
                Two maps are created that are independent of each other and
                contain their own distinct configurations.
            </FluentLabel>
        </FluentStack>
    </MapPageHeader>

    <FluentStack>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentToolbar>
                <FluentButton Disabled="@overlay" IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset Map" OnClick="@(() => ResetMap(mapIdA))" />
            </FluentToolbar>
            <AzureMap Id="@mapIdA"
                      Height="@mapHeight"
                      Width="@mapWidth"
                      Controls="@controlsA"
                      OnMapReady="@OnMapReady"
                      Options="@MapHelpers.GetDefaultCreateMapOptions()" />
        </FluentStack>

        <FluentStack Orientation="Orientation.Vertical">
            <FluentToolbar>
                <FluentButton Disabled="@overlay" IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset Map" OnClick="@(() => ResetMap(mapIdB))" />
            </FluentToolbar>
            <AzureMap Id="@mapIdB"
                      Height="@mapHeight"
                      Width="@mapWidth"
                      Controls="@controlsB"
                      OnMapReady="@OnMapReady"
                      Options="@optionsB" />
        </FluentStack>
    </FluentStack>
</FluentLayout>

<FluentOverlay @bind-Visible="@overlay"
               Transparent="false">
    <FluentProgressRing />
</FluentOverlay>

@code {
    private string hRefSource => nameof(MultipleMapsS).ToMapPageSource();
    private readonly string subject = "Multiple Maps";
    private string mapHeight = "400px";
    private string mapWidth = "100%";
    private const string mapIdA = "mapA";
    private const string mapIdB = "mapB";
    private bool overlay;
    private MapOptions optionsB = MapHelpers.GetDefaultCreateMapOptions();
    private MapOptionsSet optionsSetA = MapHelpers.GetDefaultSetMapOptions();
    private MapOptionsSet optionsSetB = MapHelpers.GetDefaultSetMapOptions();
    private IAzureMapContainer? mapInteropA;
    private IAzureMapContainer? mapInteropB;
    private List<MapControl>? controlsA;
    private List<MapControl>? controlsB;

    protected override void OnInitialized()
    {
        //Use default controls for map A
        controlsA = MapHelpers.GetDefaultControls();

        //Customize controls for map B
        controlsB = MapHelpers.GetDefaultControls();
        (controlsB.First(e => e is StyleControl) as StyleControl)?.Options = new StyleControlOptions { Layout = StyleControlLayout.List };
        
        //Customize options for map B
        optionsB.Style = new StyleOptions
        {
            Style = MapStyle.Night
        };
        optionsSetB.Style = new StyleOptions
        {
            Style = MapStyle.Night
        };
    }

    private async Task OnMapReady(IAzureMapContainer mapContainer)
    {
        try
        {
            await Task.CompletedTask;
            switch (mapContainer.MapId)
            {
                case mapIdA:
                    mapInteropA = mapContainer;
                    break;
                case mapIdB:
                    mapInteropB = mapContainer;
                    break;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
    }

    private async Task ResetMap(string mapId)
    {
        try
        {
            switch (mapId)
            {
                case mapIdA:
                    await mapInteropA!.Configuration.SetMapOptions(optionsSetA!);
				    break;
                case mapIdB:
                    await mapInteropB!.Configuration.SetMapOptions(optionsSetB!);
					break;
            }
            
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
    }
}
