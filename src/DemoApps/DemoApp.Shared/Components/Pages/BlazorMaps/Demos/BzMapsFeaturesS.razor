@* @page "/bzmaps-demos-features-convert"
@rendermode InteractiveServer *@
@using System.Text.Json
@using DemoApp.Shared.Models.BlazorMaps
@using Marqdouj.DotNet.AzureMaps.Blazor.Models.Common
@using Marqdouj.DotNet.AzureMaps.Blazor.Models.GeoJson
@inject ILogger<BzMapsFeaturesS> Logger
@inject IToastService ToastService
@inject IBzMapsDataService DataService

<PageTitle>@pageName</PageTitle>

<FluentLayout>
    <FluentHeader>@pageName</FluentHeader>
    <FluentToolbar>
        <FluentCheckbox @bind-Value="@useCamelCase" >Camel Case Serialization</FluentCheckbox>
    </FluentToolbar>

    <FluentTabs>
        <FluentTab Label="Single Feature">
            <FluentTabs>
                <FluentTab Label="FeatureDef To Feature">
                    <FluentToolbar>
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset" OnClick="@ResetConvertToFeature" />
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ConvertRange())" Title="Convert" OnClick="@ConvertToFeature" />
                    </FluentToolbar>
                    <FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapDefToFeatureJson" Label="MapFeatureDef" Rows="20" Cols="80" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapFeatureFromDefJson" Label="Feature" Rows="20" Cols="80" ReadOnly="true" />
                        </FluentStack>
                    </FluentStack>
                </FluentTab>
                <FluentTab Label="Feature to FeatureDef">
                    <FluentToolbar>
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset" OnClick="@ResetConvertToFeatureDef" />
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ConvertRange())" Title="Convert" OnClick="@ConvertToFeatureDef" />
                    </FluentToolbar>
                    <FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapFeatureToDefJson" Label="Feature" Rows="20" Cols="80" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapDefFromFeatureJson" Label="MapFeatureDef" Rows="20" Cols="80" ReadOnly="true" />
                        </FluentStack>
                    </FluentStack>
                </FluentTab>
            </FluentTabs>
        </FluentTab>
        <FluentTab Label="Collection of Features">
            <FluentTabs>
                <FluentTab Label="FeatureDefs To Features">
                    <FluentToolbar>
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset" OnClick="@ResetConvertToFeatures" />
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ConvertRange())" Title="Convert" OnClick="@ConvertToFeatures" />
                    </FluentToolbar>
                    <FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapDefsToFeaturesJson" Label="MapFeatureDefs" Rows="20" Cols="80" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapFeaturesFromDefsJson" Label="Features" Rows="20" Cols="80" ReadOnly="true" />
                        </FluentStack>
                    </FluentStack>
                </FluentTab>
                <FluentTab Label="Features to FeatureDefs">
                    <FluentToolbar>
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset" OnClick="@ResetConvertToFeatureDefs" />
                        <FluentButton IconStart="@(new Icons.Regular.Size20.ConvertRange())" Title="Convert" OnClick="@ConvertToFeatureDefs" />
                    </FluentToolbar>
                    <FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapFeaturesToDefsJson" Label="Features" Rows="20" Cols="80" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentTextArea @bind-Value="@mapDefsFromFeaturesJson" Label="MapFeatureDefs" Rows="20" Cols="80" ReadOnly="true" />
                        </FluentStack>
                    </FluentStack>
                </FluentTab>
            </FluentTabs>
        </FluentTab>
    </FluentTabs>

</FluentLayout>

@code {
    private const string pageName = "Map Feature Conversions";

    private string? mapDefToFeatureJson;
    private string? mapFeatureFromDefJson;
    private string? mapFeatureToDefJson;
    private string? mapDefFromFeatureJson;

    private string? mapDefsToFeaturesJson;
    private string? mapFeaturesFromDefsJson;
    private string? mapFeaturesToDefsJson;
    private string? mapDefsFromFeaturesJson;

    private bool useCamelCase;
    private MapFeatureDef<LineString>? lineString;
    private List<MapFeatureDef<Point>>? symbols;
    private Feature<LineString, Properties>? lineStringFeature;
    private FeatureCollection<Point, Properties>? lineStringFeatures;
    private JsonNamingPolicy? namingPolicy => useCamelCase ? JsonNamingPolicy.CamelCase : default;

    protected override async Task OnInitializedAsync()
    {
        var data = await DataService.GetLineLayerData();
        lineString = data.GetLineLayerFeatureDef();
        lineString.Id = "ConvertToFeature";
        symbols = data.GetDefaultSymbolLayerFeatures().Cast<MapFeatureDef<Point>>().ToList();
        lineStringFeature = lineString.ToFeature<LineString>();
        lineStringFeatures = symbols.ToFeatureCollection();

        ResetConvertToFeature();
        ResetConvertToFeatures();
        ResetConvertToFeatureDef();
        ResetConvertToFeatureDefs();
    }

    private void ResetConvertToFeature()
    {
        mapDefToFeatureJson = lineString!.ToJson(namingPolicy);
        mapFeatureFromDefJson = "";
    }

    private void ConvertToFeature()
    {
        try
        {
            ArgumentNullException.ThrowIfNullOrWhiteSpace(mapDefToFeatureJson);
            var featureDef = mapDefToFeatureJson.ToMapFeatureDef<LineString>();
            var feature = featureDef!.ToFeature<LineString>();
            mapFeatureFromDefJson = feature.ToJson(namingPolicy);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.ShowError(ex.Message);
        }
    }

    private void ResetConvertToFeatureDef()
    {
        mapFeatureToDefJson = lineStringFeature!.ToJson(namingPolicy);
        mapDefFromFeatureJson = "";
    }

    private void ConvertToFeatureDef()
    {
        try
        {
            ArgumentNullException.ThrowIfNullOrWhiteSpace(mapFeatureToDefJson);
            var feature = mapFeatureToDefJson.ToFeature<LineString>(namingPolicy);
            mapDefFromFeatureJson = feature?.ToMapFeatureDef<LineString>(lineString!.AsShape).ToJson(namingPolicy);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.ShowError(ex.Message);
        }
    }

    private void ResetConvertToFeatures()
    {
        mapDefsToFeaturesJson = symbols!.ToJson(namingPolicy);
        mapFeaturesFromDefsJson = "";
    }

    private void ConvertToFeatures()
    {
        try
        {
            ArgumentNullException.ThrowIfNullOrWhiteSpace(mapDefsToFeaturesJson);
            var featureDefs = mapDefsToFeaturesJson.ToMapFeatureDefs<Point>(namingPolicy);
            mapFeaturesFromDefsJson = featureDefs!.ToFeatureCollection().ToJson(namingPolicy);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.ShowError(ex.Message);
        }
    }

    private void ResetConvertToFeatureDefs()
    {
        mapFeaturesToDefsJson = lineStringFeatures!.ToJson(namingPolicy);
        mapDefsFromFeaturesJson = "";
    }

    private void ConvertToFeatureDefs()
    {
        try
        {
            ArgumentNullException.ThrowIfNullOrWhiteSpace(mapFeaturesToDefsJson);
            var features = mapFeaturesToDefsJson.ToFeatureCollection<Point>(namingPolicy);
            mapDefsFromFeaturesJson = features.ToMapFeatureDefs<Point>(false).ToJson(namingPolicy);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.ShowError(ex.Message);
        }
    }
}
